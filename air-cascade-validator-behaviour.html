<link rel="import" href="../polymer/polymer-element.html">

<link rel="import" href="../polymer/lib/utils/flattened-nodes-observer.html">


<script>

    /**
     * FiveElements Namespace definition
     */
    window.FiveElements = window.FiveElements || {};


    /**
     * @polymerMixin
     */
    FiveElements.AirCascadeValidatorMixin = (superclass) => class extends superclass {


        static get properties() {
            return {
                novalidate: {
                    type: Boolean
                }
            };
        }

        // --- Life Cycle
        // --- ---------------------------
//
//        constructor() {
//          super();
//          this._customElements = [];
//          this._boundListenerironFormElementRegister = this._registerValidateElement.bind(this);
//          this._boundListenerironFormElementUnregister = this._unregisterValidateElement.bind(this);
//        }
//
//        connectedCallback() {
//          super.connectedCallback();
//          window.addEventListener('iron-form-element-register', this._boundListenerironFormElementRegister);
//          window.addEventListener('iron-form-element-unregister', this._boundListenerironFormElementUnregister);
//        }
//
//        disconnectedCallback() {
//          super.disconnectedCallback();
//          window.removeEventListener('iron-form-element-register', this._boundListenerironFormElementRegister);
//          window.removeEventListener('iron-form-element-unregister', this._boundListenerironFormElementUnregister);
//        }
//
 



        // --- Node Watcher
        // --- ---------------------------
//        _registerValidateElement(e) {
//            // Get the actual element that fired the event
//            console.log('register elt ', e);
//            let element = Polymer.dom(e).rootTarget;
//
//            element._parentForm = this;
////            if (this !== element) {
//            this._customElements.push(element);
////            }
//        }
//
//        _unregisterValidateElement(e) {
//            let target = e.detail.target;
//            if (target) {
//                let index = this._customElements.indexOf(target);
//                if (index > -1) {
//                    this._customElements.splice(index, 1);
//                }
//            }
//        }

        // --- Public Api
        // --- ---------------------------
        /**
         * Validates all the required elements (custom and native) in the form.
         * @return {boolean} True if all the elements are valid.
         */
        validate() {
            console.log('validate...');
            if (this.novalidate) {
                return true;
            }
            // Start by making the form check the native elements it knows about.
//            let valid = this._form.checkValidity();
            let elements = this._getValidatableElements(this.$.dataForm);
            // Go through all the elements, and validate the custom ones.
            let valid = false;
            for (let el, i = 0; el = elements[i], i < elements.length; i++) {
                // This is weird to appease the compiler. We assume the custom element
                // has a validate() method, otherwise we can't check it.
                let validatable = /** @type {{validate: (function() : boolean)}} */ (el);
                if (validatable.validate) {
                    valid = !!validatable.validate() && valid;
                }
            }
            console.log('is valid ==> ' + valid);
            return valid;
        };


        // --- Validators iron-form
        // --- ---------------------------

        _getValidatableElements(parent) {
            return this._computeValidatableElements(parent);
        }

        /**
         * Visist all child nodes of parent
         * @param parent
         * @returns {*}
         * @private
         */
        _computeValidatableElements(parent) {
            let nodes = Array.prototype.slice.call(Polymer.FlattenedNodesObserver.getFlattenedNodes(parent));
            let elements = nodes.reduce((acc,el) =>{
                // Test node
                let validatable = /** @type {{validate: (function() : boolean)}} */ (el);
                if (validatable.validate) {
                      acc.push(validatable);
                      return acc;
                }
                // Test childrens
                let shadowNode =  el.shadowRoot;
                if  (shadowNode && shadowNode.mode === 'open') {
                    let childElt = this._getValidatableElements(shadowNode);
                    acc.push(...childElt);
                }
                return acc;
            }, []);
//            console.log(elements);
            return elements;
        };



        // --- End
        // --- ---------------------------
    };


</script>
