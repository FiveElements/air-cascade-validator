<link rel="import" href="../polymer/polymer-element.html">

<link rel="import" href="../polymer/lib/utils/flattened-nodes-observer.html">


<script>

    /**
     * FiveElements Namespace definition
     */
    window.FiveElements = window.FiveElements || {};


    /**
     * @polymerMixin
     */
    FiveElements.AirCascadeValidatorMixin = superclass => class extends superclass {

        
        constructor() {
          super();
          this._boundListenerironFormElementRegister = this._registerValidateElement.bind(this);
          this._boundListenerironFormElementUnregister = this._unregisterValidateElement.bind(this);
        }

        connectedCallback() {
          super.connectedCallback();
          window.addEventListener('iron-form-element-register', this._boundListenerironFormElementRegister);
          window.addEventListener('iron-form-element-unregister', this._boundListenerironFormElementUnregister);
        }

        disconnectedCallback() {
          super.disconnectedCallback();
          window.removeEventListener('iron-form-element-register', this._boundListenerironFormElementRegister);
          window.removeEventListener('iron-form-element-unregister', this._boundListenerironFormElementUnregister);
        }
        
 


        // --- Life Cycle
        // --- ---------------------------
        ready() {
             super.ready();
            // Holds all the custom elements registered with this form.
            this._customElements = [];
        }


        // --- Node Watcher
        // --- ---------------------------
        _registerValidateElement(e) {
            // Get the actual element that fired the event
            let element = Polymer.dom(e).rootTarget;

            element._parentForm = this;
//            if (this !== element) {
            this._customElements.push(element);
//            }
        }

        _unregisterValidateElement(e) {
            let target = e.detail.target;
            if (target) {
                let index = this._customElements.indexOf(target);
                if (index > -1) {
                    this._customElements.splice(index, 1);
                }
            }
        }

        // --- Public Api
        // --- ---------------------------
        validate(callback) {
//            return this._validateAllNodes(callback);
            return this._validate();
        }


        // --- Validators iron-form
        // --- ---------------------------
        /**
         * Validates all the required elements (custom and *NOT* native) in the form.
         * @return {boolean} True if all the elements are valid.
         */
        _validate() {
            let valid = true;
            // Validate all the custom elements.
            let validatable;
            for (let el, i = 0; el = this._customElements[i], i < this._customElements.length; i++) {
                if (!this._isChildOfRegisteredParent(el, false) && !el.disabled) {
                    validatable = /** @type {{validate: (function() : boolean)}} */ (el);
                    // Some elements may not have correctly defined a validate method.
                    if (validatable.validate)
                        valid = !!validatable.validate() && valid;
                }
            }
            // Validate the form's native elements.
            if (this.elements) {
                valid = this._validateNativeElements(this.elements) && valid;
            }
            return valid;
        }

        _validateNativeElements(elements) {
            let valid = true;
            for (let el, i = 0; el = this.elements[i], i < this.elements.length; i++) {
                // If this native element is inside a custom element that has already
                // registered to this form, skip it.
                if (this._isChildOfRegisteredParent(el, false)) {
                    continue;
                }
                // Custom elements that extend a native element will also appear in
                // this list, but they've already been validated.
                if (!el.hasAttribute('is') && el.willValidate && el.checkValidity) {
                    valid = el.checkValidity() && valid;
                }
            }
            return valid;
        }


        /**
         * Returns true if `node` is in the shadow DOM of a different element,
         * that has also implemented IronFormElementBehavior and is registered
         * to this form. The second parameter specifies if the parent must have a
         * name to be considered.
         */
        _isChildOfRegisteredParent(node, checkHasName) {
            let parent = node;
            // At some point going up the tree we'll find either this form or the document.
            while (parent && parent !== document && parent != this) {
                // Use logical parentnode, or native ShadowRoot host.
                parent = Polymer.dom(parent).parentNode || parent.host;
                // Check if the parent was registered and submittable.
                if (parent &&
                    (!checkHasName || parent.name) &&
                    parent._parentForm === this) {
                    return true;
                }
            }
            return false;
        }

        // --- Validators Simple
        // --- ---------------------------

        _validateAllNodes(notValidNodesCallback) {
            let childNodes = this._customElements;
            // Compute InValid nodes
            let notValidNodes = Array.prototype.filter.call(childNodes, function (childNode) {
                if (typeof childNode.checkValidity === 'function') {
                    return !childNode.checkValidity();
                } else if (typeof childNode.validate === 'function') {
                    return !childNode.validate();
                }
                return false;
            });
            // Not Valid Callback
            if (notValidNodesCallback) {
                notValidNodesCallback(notValidNodes);
            }
            // Return
            return notValidNodes.length < 1;
        }


        // --- End
        // --- ---------------------------
    };


</script>
